{% extends "shared/base.html" %}

{% block title %}Settings - SkillSwap{% endblock %}

{% block styles %}
<link href="{{ url_for('static', filename='css/shared/settings.css') }}" rel="stylesheet">
{% endblock %}

{% block content %}
<div class="container py-5">
    <!-- Back Link (optional based on screenshot "Back") -->
    <a href="{{ url_for('dashboard.dashboard') }}" class="text-decoration-none text-muted mb-4 d-inline-block">
        <i class="bi bi-arrow-left me-1"></i> Back
    </a>

    <h2 class="fw-bold mb-4" id="pageTitle">Settings</h2>

    <div class="row">
        <!-- Sidebar -->
        <div class="col-lg-3 d-none d-lg-block">
            <nav class="settings-sidebar">
                <div class="section-title">Account</div>
                <button class="nav-link active w-100 text-start border-0 bg-transparent" id="navProfile">
                    <i class="bi bi-person"></i> Profile
                </button>
                {% if not user.is_google_user %}
                <button class="nav-link w-100 text-start border-0 bg-transparent" id="navPassword">
                    <i class="bi bi-shield-lock"></i> Password
                </button>
                {% endif %}

                <div class="section-title">Others</div>
                <button class="nav-link w-100 text-start border-0 bg-transparent" id="navSkills">
                    <i class="bi bi-award"></i> Skills
                </button>
                <button class="nav-link w-100 text-start border-0 bg-transparent" id="navVerification">
                    <i class="bi bi-patch-check"></i> Verification
                </button>
                <button class="nav-link w-100 text-start border-0 bg-transparent" id="navPrivacy">
                    <i class="bi bi-file-text"></i> Privacy Policy
                </button>
            </nav>
        </div>

        <!-- Main Content -->
        <div class="col-lg-9">
            <!-- 
                PROFILE SECTION 
                - View and Edit Personal Information
                - Handles Profile Photo Upload
            -->
            <div id="profileSection">
                <form id="settingsForm" class="settings-form is-readonly">
                    <!-- Profile Header -->
                    <div class="d-flex align-items-center gap-4 mb-5">
                        <!-- Profile Image -->
                        <div class="profile-avatar-container">
                            {% if user.profile_photo %}
                            <img src="{{ url_for('static', filename='img/users/profiles/' + user.profile_photo) }}"
                                alt="Profile" class="profile-avatar" id="avatarPreview">
                            {% else %}
                            <img src="https://ui-avatars.com/api/?name={{ user.first_name }}+{{ user.last_name }}&background=1e293b&color=fff&size=128"
                                alt="Profile" class="profile-avatar" id="avatarPreview">
                            {% endif %}

                            <!-- Upload Button (only visible when editing) -->
                            <label for="profile_photo" class="profile-upload-btn" title="Change Photo">
                                <i class="bi bi-camera-fill"></i>
                            </label>
                            <input type="file" id="profile_photo" name="profile_photo" accept="image/*" hidden disabled>
                        </div>

                        <!-- Header Info -->
                        <div>
                            <div class="d-flex align-items-center flex-wrap gap-2 mb-2">
                                {% if user.verification_status == 'verified' %}
                                <div class="d-flex align-items-center text-success fw-bold small">
                                    <i class="bi bi-patch-check-fill me-1"></i> Verified Account
                                </div>
                                {% else %}
                                <div class="d-flex align-items-center text-muted fw-bold small">
                                    <i class="bi bi-x-circle-fill me-1"></i> Account Unverified
                                </div>
                                <span class="text-muted">|</span>
                                <span class="text-muted small">You cannot connect with others until verified</span>
                                <button type="button" id="btnVerifyNow" class="btn btn-sm btn-secondary ms-2"
                                    style="background:#e5e7eb; color: #374151; border:none; font-size: 0.75rem; padding: 0.25rem 0.75rem; border-radius: 4px;">Verify
                                    Now</button>
                                {% endif %}
                            </div>
                            <div class="text-muted fw-medium">{{ user.role|capitalize }} | {{ user.age }} Years Old
                            </div>
                        </div>
                    </div>

                    <!-- Form Fields -->
                    <div class="row g-4">
                        <div class="col-md-6">
                            <label class="form-label text-muted small text-uppercase">üë§ First Name</label>
                            <input type="text" class="form-control-plaintext form-input-global" name="first_name"
                                value="{{ user.first_name }}" disabled required>
                        </div>

                        <div class="col-md-6">
                            <label class="form-label text-muted small text-uppercase">üåê Language</label>
                            <!-- Using text input if disabled, select if enabled? For simplicity text input that becomes select or just text. 
                                 Theme request implies "View personal details". Let's stick to text for now or simple input. -->
                            <input type="text" class="form-control-plaintext form-input-global" name="language"
                                value="{{ user.language }}" disabled>
                        </div>

                        <div class="col-md-6">
                            <label class="form-label text-muted small text-uppercase">üë§ Last Name</label>
                            <input type="text" class="form-control-plaintext form-input-global" name="last_name"
                                value="{{ user.last_name }}" disabled required>
                        </div>

                        <div class="col-md-6">
                            <label class="form-label text-muted small text-uppercase">üéì Profession/School</label>
                            <input type="text" class="form-control-plaintext form-input-global" name="profession"
                                value="{{ user.profession }}" placeholder="Add your profession" disabled>
                        </div>

                        <div class="col-md-6">
                            <label class="form-label text-muted small text-uppercase">üèòÔ∏è GRC (Constituency)</label>
                            <select class="form-select form-input-global" name="grc_id" disabled>
                                <option value="">Select your GRC</option>
                                {% for grc in grcs %}
                                <option value="{{ grc.grc_id }}" {% if user.grc_id==grc.grc_id %}selected{% endif %}>
                                    {{ grc.name }} ({{ grc.region }})
                                </option>
                                {% endfor %}
                            </select>
                        </div>

                        <div class="col-md-6">
                            <label class="form-label text-muted small text-uppercase">üéÇ Birth Date</label>
                            <input type="date" class="form-control-plaintext form-input-global" name="birth_date"
                                value="{{ user.birth_date }}" disabled>
                        </div>

                        <div class="col-12">
                            <label class="form-label text-muted small text-uppercase">üìù Bio</label>
                            <textarea class="form-control-plaintext form-input-global" name="bio" rows="4"
                                placeholder="Short sentence about yourself" disabled>{{ user.bio }}</textarea>
                        </div>
                    </div>

                    <!-- Edit Button (Hide when editing) -->
                    <div class="d-flex justify-content-end mt-5" id="editContainer">
                        <div class="d-flex gap-2">
                            <button type="button" id="stopEditBtn" class="btn btn-outline-secondary d-none"
                                style="padding: 0.75rem 2rem;">Stop Editing</button>
                            <button type="button" id="editBtn" class="btn btn-secondary"
                                style="background: #9ca3af; color: white; border: none; padding: 0.75rem 2rem;">Edit
                                Profile</button>
                        </div>
                    </div>
                </form>
            </div>

            <!-- 
                PASSWORD SECTION 
                - Change Password functionality
                - Disabled for Google OAuth users
            -->
            <div id="passwordSection" class="d-none">
                <h4 class="fw-bold mb-4">Change Password</h4>
                <form id="passwordForm" class="settings-form">
                    <div class="row g-4">
                        <div class="col-md-6">
                            <label class="form-label text-muted small text-uppercase">‚úâÔ∏è Email</label>
                            <input type="email" class="form-control form-input-global" value="{{ user.email }}" readonly
                                disabled>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label text-muted small text-uppercase">üîí New Password</label>
                            <input type="password" class="form-control form-input-global" name="new_password"
                                placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label text-muted small text-uppercase">üîë Current Password</label>
                            <input type="password" class="form-control form-input-global" name="current_password"
                                placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label text-muted small text-uppercase">üîí Confirm New Password</label>
                            <input type="password" class="form-control form-input-global" name="confirm_password"
                                placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                        </div>
                    </div>

                    <div class="d-flex justify-content-end mt-5">
                        <button type="button" id="updatePassBtn" class="btn btn-secondary"
                            style="background: #9ca3af; color: white; border: none; padding: 0.75rem 2rem;">Update
                            Password</button>
                    </div>
                </form>
            </div>

            <!-- 
                SKILLS SECTION 
                - Manage Offered Skills (Teach) and Interested Skills (Learn)
                - Supports adding from suggestions or custom input
            -->
            <div id="skillsSection" class="d-none">
                <h4 class="fw-bold mb-2">Manage Skills</h4>
                <p class="text-muted mb-4">Update the skills you want to teach or learn to find better matches</p>

                <!-- Custom Tabs -->
                <div class="d-flex text-center mb-4" style="border-bottom: 2px solid #e5e7eb;">
                    <button class="flex-fill py-3 border-0 bg-transparent fw-bold" id="tabTeach"
                        style="border-bottom: 2px solid black; margin-bottom: -2px;">Teach</button>
                    <button class="flex-fill py-3 border-0 bg-transparent text-muted" id="tabLearn"
                        style="margin-bottom: -2px;">Learn</button>
                </div>

                <!-- Teacher Skills Container -->
                <div id="teachContainer">
                    <h6 class="fw-bold small text-uppercase text-muted mb-3">Skills I can teach</h6>
                    <div class="p-4 rounded-3 mb-4" style="background-color: #d1d5db;">
                        <!-- Gray background from image -->
                        <div class="d-flex flex-wrap gap-2" id="teachSelectedList">
                            <!-- Selected Pills will act here -->
                        </div>
                        <div id="teachEmptyState" class="text-muted small fst-italic mt-2 d-none">No skills selected
                        </div>
                    </div>

                    <h6 class="fw-bold small text-uppercase text-muted mb-3">Add more:</h6>
                    <div class="d-flex flex-wrap gap-2 mb-4" id="teachSuggestedList">
                        <!-- Suggested Pills -->
                    </div>

                    <h6 class="fw-bold small text-uppercase text-muted mb-2">Can't find? Write Yourself</h6>
                    <input type="text" class="form-control form-input-global mb-4" id="teachCustomInput"
                        placeholder="Type a skill and press Enter">
                </div>

                <!-- Learner Skills Container (Hidden by default) -->
                <div id="learnContainer" class="d-none">
                    <h6 class="fw-bold small text-uppercase text-muted mb-3">Skills I want to learn</h6>
                    <div class="p-4 rounded-3 mb-4" style="background-color: #d1d5db;">
                        <div class="d-flex flex-wrap gap-2" id="learnSelectedList">
                            <!-- Selected Pills -->
                        </div>
                        <div id="learnEmptyState" class="text-muted small fst-italic mt-2 d-none">No skills selected
                        </div>
                    </div>

                    <h6 class="fw-bold small text-uppercase text-muted mb-3">Add more:</h6>
                    <div class="d-flex flex-wrap gap-2 mb-4" id="learnSuggestedList">
                        <!-- Suggested Pills -->
                    </div>

                    <h6 class="fw-bold small text-uppercase text-muted mb-2">Can't find? Write Yourself</h6>
                    <input type="text" class="form-control form-input-global mb-4" id="learnCustomInput"
                        placeholder="Type a skill and press Enter">
                </div>

                <!-- Save Action Removed (Using Sticky Bar) -->
            </div>

            <!-- VERIFICATION SECTION -->
            <!-- 
                VERIFICATION SECTION 
                - Display current verification status
                - Upload interface for ID documents
            -->
            <div id="verificationSection" class="d-none">
                <div class="d-flex align-items-center gap-2 mb-4">
                    <h4 class="fw-bold mb-0">Verification Status</h4>
                    {% if user.verification_status == 'verified' %}
                    <svg class="verified-icon text-success" style="width: 28px; height: 28px;" viewBox="0 0 24 24"
                        fill="currentColor">
                        <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" stroke="currentColor" stroke-width="2"
                            fill="none" />
                        <path
                            d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z" />
                    </svg>
                    {% elif user.verification_status == 'pending' %}
                    <i class="bi bi-hourglass-split fw-bold text-warning" style="font-size: 1.5rem;"></i>
                    {% else %}
                    <i class="bi bi-x-lg fw-bold" style="font-size: 1.5rem; color: #000;"></i>
                    {% endif %}
                </div>

                {% if user.verification_status == 'verified' %}
                <div class="verification-success-box">
                    <h3 class="fw-bold mb-2" style="font-size: 18px; color: #1a4d1a;">You are Verified!</h3>
                    <p class="mb-0" style="font-size: 14px; color: #1a4d1a;">Thank you for helping us keep the community
                        safe</p>
                </div>
                {% elif user.verification_status == 'pending' %}
                <!-- Pending State - Yellow Box -->
                <div class="alert mb-4"
                    style="background-color: #fef9c3; border: 1px solid #fde047; border-radius: 12px; padding: 25px; color: #854d0e;">
                    <h5 class="fw-bold mb-2"><i class="bi bi-clock-history me-2"></i>Verification In Progress</h5>
                    <p class="mb-1" style="font-size: 0.95rem;">Thank you for submitting your documents.</p>
                    <p class="mb-0 small opacity-75">Our team is reviewing your application. This normally takes 1-2
                        business days.</p>
                </div>
                {% else %}
                <!-- Unverified State - Red Box -->
                <div class="alert mb-4"
                    style="background-color: #d88e8e; color: #1f1f1f; border: none; border-radius: 12px; padding: 25px;">
                    <h5 class="fw-bold mb-2" style="color: #000;">Verification Required for FULL ACCESS</h5>
                    <p class="mb-0 small" style="color: #000;">Please upload a photo ID to verify your account</p>
                </div>

                <!-- Upload Zone -->
                <div class="upload-zone p-5 text-center mb-4"
                    style="background-color: #f3f4f6; border-radius: 8px; border: 2px dashed #e5e7eb; cursor: pointer; transition: all 0.2s;"
                    onclick="document.getElementById('verificationFile').click()" id="uploadZone">
                    <input type="file" id="verificationFile" hidden accept="image/*">
                    <div id="uploadPlaceholder">
                        <i class="bi bi-camera fs-1 mb-2 d-block text-dark"></i>
                        <h6 class="fw-bold mb-1 text-dark">Click to upload photo ID</h6>
                        <span class="text-muted small">JPG or PNG</span>
                    </div>
                    <div id="uploadPreviewContainer" class="d-none">
                        <img id="uploadPreview" src="" alt="Preview"
                            style="max-width: 100%; max-height: 200px; border-radius: 8px; margin-bottom: 10px;">
                        <p class="text-success fw-bold small mb-0">Image Selected</p>
                    </div>
                </div>

                <button id="submitVerificationBtn" class="btn w-100 py-3 text-white fw-bold"
                    style="background-color: #808080; border-radius: 8px;" disabled>Submit Documents</button>
                {% endif %}
            </div>

            <!-- PRIVACY POLICY SECTION -->
            <div id="privacySection" class="d-none">
                <div class="d-flex align-items-center justify-content-between mb-4">
                    <h4 class="fw-bold mb-0">Privacy Policy</h4>
                    <span class="badge bg-light text-muted border">Effective: Jan 2026</span>
                </div>

                <div class="card border-0 shadow-sm">
                    <div class="card-body p-4 p-lg-5" style="background-color: #f8fafc; border-radius: 12px;">
                        <div class="privacy-content"
                            style="max-height: 600px; overflow-y: auto; padding-right: 15px; scrollbar-width: thin; scrollbar-color: #cbd5e1 transparent;">
                            <h5 class="fw-bold mb-3">1. Introduction</h5>
                            <p class="text-muted mb-4">Welcome to SkillSwap. We respect your privacy and are committed
                                to
                                protecting your personal data. This privacy policy will inform you as to how we look
                                after
                                your personal data when you visit our website and tell you about your privacy rights and
                                how
                                the law protects you.</p>

                            <h5 class="fw-bold mb-3">2. Data We Collect</h5>
                            <p class="text-muted mb-2">We may collect, use, store and transfer different kinds of
                                personal
                                data about you which we have grouped together follows:</p>
                            <ul class="text-muted mb-4 ps-3">
                                <li class="mb-2"><strong>Identity Data:</strong> First name, last name, username, date
                                    of
                                    birth.</li>
                                <li class="mb-2"><strong>Contact Data:</strong> Email address and optional phone number.
                                </li>
                                <li><strong>Profile Data:</strong> Your interests, skills to teach, skills to learn, and
                                    verification documents.</li>
                            </ul>

                            <h5 class="fw-bold mb-3">3. How We Use Your Data</h5>
                            <p class="text-muted mb-2">We will only use your personal data when the law allows us to.
                                Most
                                commonly, we will use your personal data in the following circumstances:</p>
                            <ul class="text-muted mb-4 ps-3">
                                <li class="mb-2">To register you as a new user.</li>
                                <li class="mb-2">To match you with other users for skill swapping.</li>
                                <li>To manage our relationship with you and improve our services.</li>
                            </ul>

                            <h5 class="fw-bold mb-3">4. Data Security</h5>
                            <p class="text-muted mb-4">We have put in place appropriate security measures to prevent
                                your
                                personal data from being accidentally lost, used or accessed in an unauthorized way,
                                altered
                                or disclosed. We limit access to your personal data to those employees, agents,
                                contractors
                                and other third parties who have a business need to know.</p>

                            <h5 class="fw-bold mb-3">5. Contact Us</h5>
                            <p class="text-muted mb-0">If you have any questions about this privacy policy, please
                                contact
                                our support team at <a href="mailto:privacy@skillswap.com"
                                    class="text-primary text-decoration-none">privacy@skillswap.com</a>.</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Unsaved Changes Sticky Bar -->
            <div class="unsaved-changes-bar" id="unsavedBar">
                <span class="fs-5">You have Unsaved Changes</span>
                <div class="d-flex gap-3">
                    <button type="button" id="clearBtn"
                        class="btn btn-link text-decoration-none text-dark fw-bold">Clear</button>
                    <button type="button" id="saveBtn" class="btn btn-dark px-4 rounded-pill">Save Changes</button>
                </div>
            </div>

            {% endblock %}

            {% block scripts %}
            <!-- Data Storage for Skills -->
            <script type="application/json" id="data-teach-skills">{{ teach_skills | tojson }}</script>
            <script type="application/json" id="data-learn-skills">{{ learn_skills | tojson }}</script>
            <script type="application/json" id="data-all-skills">{{ all_skills | tojson }}</script>

            <script src="{{ url_for('static', filename='js/toast.js') }}"></script>
            <script src="{{ url_for('static', filename='js/settings.js') }}"></script>
            {% endblock %}