{% extends "shared/base.html" %}

{% block title %}SkillSwap - Support Center{% endblock %}

{% block styles %}
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="{{ url_for('static', filename='css/youth/youthsupportcentre.css') }}?v=3">
{% endblock %}

{% block content %}
<div class="main-container">
    <aside class="sidebar">
        <a href="{{ url_for('dashboard.dashboard') }}" class="back-link">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <line x1="19" y1="12" x2="5" y2="12" />
                <polyline points="12 19 5 12 12 5" />
            </svg>
            Back to Dashboard
        </a>
        <h1 class="sidebar-title">Support Center</h1>
        <p class="sidebar-subtitle">How can we be of assistance</p>
        <nav class="sidebar-nav">
            <a href="#" class="active" data-page="get-help-page">Get Help</a>
            <a href="#" data-page="safety-center-page">Safety Center</a>
            <a href="#" data-page="my-tickets-page">My Tickets</a>
            <a href="#" data-page="live-chats-page">Live Chats</a>
        </nav>
    </aside>

    <main class="content">
        <div id="get-help-page" class="page active">
            <h2 class="content-title">Frequently Answered Questions</h2>

            <div class="faq-list">
                <div class="faq-item">
                    <button class="faq-question">
                        How do I verify my account
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <polyline points="6 9 12 15 18 9" />
                        </svg>
                    </button>
                    <div class="faq-answer">
                        <div class="faq-answer-content">
                            To verify your account, navigate to your Profile Settings and select 'Verify Identity'. You
                            will need to upload a photo of your Student ID (for youth) or a valid photo ID (for
                            seniors). Verification helps us maintain a safe community for everyone.
                        </div>
                    </div>
                </div>

                <div class="faq-item">
                    <button class="faq-question">
                        How do I earn points
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <polyline points="6 9 12 15 18 9" />
                        </svg>
                    </button>
                    <div class="faq-answer">
                        <div class="faq-answer-content">
                            You earn points by being an active community member! You can gain points by hosting a skill
                            workshop, attending events, or leaving helpful reviews for others. Check the 'Rewards' tab
                            to see how you can redeem your points for vouchers and badges.
                        </div>
                    </div>
                </div>

                <div class="faq-item">
                    <button class="faq-question">
                        Is my personal data safe
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <polyline points="6 9 12 15 18 9" />
                        </svg>
                    </button>
                    <div class="faq-answer">
                        <div class="faq-answer-content">
                            Yes, your privacy is our top priority. We use industry-standard encryption to protect your
                            personal information. We never share your contact details with other users until you
                            explicitly agree to connect with them for a skill-swap session.
                        </div>
                    </div>
                </div>

                <div class="faq-item">
                    <button class="faq-question">
                        How do I sign up for events
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <polyline points="6 9 12 15 18 9" />
                        </svg>
                    </button>
                    <div class="faq-answer">
                        <div class="faq-answer-content">
                            Go to the 'Events' tab in the top navigation bar to browse upcoming workshops. Once you find
                            an event you like, simply click the 'Register' button. You will receive a confirmation email
                            with the event details and a calendar invite.
                        </div>
                    </div>
                </div>
            </div>

            <h3 class="help-section-title">Still need Help?</h3>
            <div class="contact-cards">
                <div class="contact-card">
                    <a href="https://mail.google.com/mail/?view=cm&fs=1&to=support@skillswap.sg" class="support-option"
                        target="_blank" rel="noopener noreferrer">

                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z" />
                            <polyline points="22,6 12,13 2,6" />
                        </svg>
                        <div class="option-text">
                            <div class="contact-card-title">Email Support</div>
                            <div class="contact-card-subtitle">Response within 24h</div>
                        </div>
                    </a>
                </div>
                <div class="contact-card">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                        stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                        <path
                            d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z" />
                    </svg>
                    <div class="contact-card-title">Call Us</div>
                    <div class="contact-card-subtitle">Mon - Fri, 9am - 6pm, 6273 8328</div>
                </div>
            </div>
        </div>

        <div id="safety-center-page" class="page">
            <h2 class="content-title">Safety Reporting Center</h2>
            <p class="page-subtitle">We take safety seriously</p>
            <div class="divider"></div>

            <div class="report-form" id="safety-report-form">
                <div class="form-group">
                    <label class="form-label">Who is involved</label>
                    <input type="text" class="form-input" id="involved-person"
                        placeholder="Enter name or leave blank if unknown">
                </div>

                <div class="form-group">
                    <label class="form-label">Issue Type</label>
                    <div class="select-wrapper">
                        <select class="form-select" id="issue-type">
                            <option value="Inappropriate Behavior">Inappropriate Behavior</option>
                            <option value="Harassment">Harassment</option>
                            <option value="Spam">Spam</option>
                            <option value="Safety Concern">Safety Concern</option>
                            <option value="Other">Other</option>
                        </select>
                        <svg class="select-arrow" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <polyline points="6 9 12 15 18 9" />
                        </svg>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">Event Name</label>
                    <div class="select-wrapper">
                        <select class="form-select" id="event-name">
                            <option value="" disabled selected>Select an event</option>
                            <option value="Workshop: Web Development">Workshop: Web Development</option>
                            <option value="Seminar: AI Basics">Seminar: AI Basics</option>
                            <option value="Meetup: Networking">Meetup: Networking</option>
                            <option value="Workshop: Python Programming">Workshop: Python Programming</option>
                            <option value="Other">Other / Not Event Related</option>
                        </select>
                        <svg class="select-arrow" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <polyline points="6 9 12 15 18 9" />
                        </svg>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">Description of Incident</label>
                    <textarea class="form-textarea" id="incident-description"
                        placeholder="Please describe what happened in detail..." rows="4"></textarea>
                </div>

                <div class="form-group">
                    <div class="upload-area" id="upload-area">
                        <span class="upload-text">Upload Screenshot (Optional)</span>
                        <input type="file" class="upload-input" id="screenshot-upload" accept="image/*"
                            onchange="handleScreenshotUpload(event)">
                    </div>
                    <div id="screenshot-preview" style="display: none; margin-top: 10px; position: relative;">
                        <img id="preview-image" src="" alt="Screenshot preview"
                            style="max-width: 100%; max-height: 200px; border-radius: 8px; border: 2px solid #e0e0e0;">
                        <button type="button" class="delete-screenshot-btn" onclick="deleteScreenshot()"
                            style="position: absolute; top: 5px; right: 5px; background: #dc2626; color: white; border: none; border-radius: 50%; width: 30px; height: 30px; cursor: pointer; font-size: 18px; line-height: 1; box-shadow: 0 2px 4px rgba(0,0,0,0.2);">Ã—</button>
                    </div>
                </div>

                <button class="submit-btn" id="submit-report-btn" onclick="submitReport()">Submit Report</button>

                <div class="form-success" id="form-success" style="display: none; margin-top: 15px; color: green;">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14" />
                        <polyline points="22 4 12 14.01 9 11.01" />
                    </svg>
                    <p style="display:inline; margin-left: 10px;">Report submitted successfully! You can view it in My
                        Tickets.</p>
                </div>
            </div>
        </div>

        <script>
            // Global variable to store the selected file
            let selectedScreenshot = null;

            // Handle screenshot upload and preview
            function handleScreenshotUpload(event) {
                const file = event.target.files[0];
                if (file) {
                    selectedScreenshot = file;
                    const reader = new FileReader();
                    reader.onload = function (e) {
                        document.getElementById('preview-image').src = e.target.result;
                        document.getElementById('screenshot-preview').style.display = 'block';
                    };
                    reader.readAsDataURL(file);
                }
            }

            // Delete screenshot
            function deleteScreenshot() {
                selectedScreenshot = null;
                document.getElementById('screenshot-upload').value = '';
                document.getElementById('screenshot-preview').style.display = 'none';
                document.getElementById('preview-image').src = '';
            }

            async function submitReport() {
                // 1. Get the button and disable it to prevent double-clicks
                const btn = document.getElementById('submit-report-btn');
                const originalText = btn.innerText;
                btn.disabled = true;
                btn.innerText = "Sending...";

                // 2. Collect data from your specific HTML IDs
                const involvedPerson = document.getElementById('involved-person').value;
                const descriptionText = document.getElementById('incident-description').value;

                // Create FormData to handle file upload
                const formData = new FormData();
                formData.append('issueType', document.getElementById('issue-type').value);
                formData.append('eventName', document.getElementById('event-name').value);
                formData.append('description', `Involved: ${involvedPerson}

${descriptionText}`);

                // Add screenshot if one was selected
                if (selectedScreenshot) {
                    formData.append('screenshot', selectedScreenshot);
                }

                try {
                    // 3. Send data to the Python Route '/submit-ticket'
                    const response = await fetch('/submit-ticket', {
                        method: 'POST',
                        body: formData  // Send FormData instead of JSON
                    });

                    const result = await response.json();

                    if (response.ok) {
                        // 4. Show success message
                        document.getElementById('form-success').style.display = 'block';

                        // Clear the form
                        document.getElementById('involved-person').value = '';
                        document.getElementById('incident-description').value = '';
                        deleteScreenshot();  // Clear screenshot

                        // Hide success message after 3 seconds
                        setTimeout(() => {
                            document.getElementById('form-success').style.display = 'none';
                        }, 5000);
                    } else {
                        alert("Error: " + result.message);
                    }
                } catch (error) {
                    console.error("Error:", error);
                    alert("An error occurred while sending the report.");
                } finally {
                    // Re-enable button
                    btn.disabled = false;
                    btn.innerText = originalText;
                }
            }
        </script>

        <!-- My Tickets Page -->
        <div id="my-tickets-page" class="page">
            <div class="tickets-layout">

                <div class="tickets-list-section">
                    <h2 class="content-title">My Tickets</h2>
                    <p class="page-subtitle">View all tickets submitted here</p>
                    <div class="divider"></div>

                    <div class="tickets-list" id="tickets-list">
                        {% for ticket in tickets %}
                        <div class="ticket-card {% if loop.first %}active{% endif %}"
                            onclick="showTicketDetails('{{ ticket.ticket_id }}', this)">

                            <div class="ticket-title">{{ ticket.subject }}</div>

                            <p class="ticket-description">
                                {{ ticket.description[:80] }}...
                            </p>

                            <div class="ticket-meta">
                                <span class="ticket-id">ID: #{{ ticket.ticket_id }}</span>
                                <span class="ticket-date">Submitted: {{ ticket.created_at }}</span>

                                {% if ticket.status == 'resolved' %}
                                <span class="ticket-status status-resolved">Resolved</span>
                                {% else %}
                                <span class="ticket-status status-progress">In Progress</span>
                                {% endif %}
                            </div>
                        </div>
                        {% else %}
                        <div class="empty-tickets">
                            <p>No tickets found. Submit a report in the Safety Center to create a ticket.</p>
                        </div>
                        {% endfor %}
                    </div>
                </div>

                <div class="ticket-detail-panel" id="ticket-detail-panel">

                    {% for ticket in tickets %}
                    <div id="detail-{{ ticket.ticket_id }}" class="ticket-full-detail"
                        style="display: {{ 'block' if loop.first else 'none' }};">

                        <h3 class="detail-id">ID: #{{ ticket.ticket_id }}</h3>

                        <div class="detail-section">
                            <div class="detail-label">ISSUE TYPE</div>
                            <div class="detail-value">{{ ticket.subject }}</div>
                        </div>

                        <div class="detail-section">
                            <div class="detail-label">PERSON INVOLVED</div>
                            <div class="detail-value">{{ ticket.user_name if ticket.user_name else 'You' }}</div>
                        </div>

                        <div class="detail-section">
                            <div class="detail-label">DESCRIPTION</div>
                            <div class="detail-box">
                                <p style="white-space: pre-wrap;">{{ ticket.description }}</p>
                            </div>
                        </div>

                        {% if ticket.screenshot_path %}
                        <div class="detail-section">
                            <div class="detail-label">SCREENSHOT</div>
                            <div class="detail-box" style="padding: 15px;">
                                <img src="{{ ticket.screenshot_path }}" alt="Ticket screenshot"
                                    style="max-width: 100%; max-height: 400px; border-radius: 8px; border: 2px solid #e0e0e0; display: block;">
                            </div>
                        </div>
                        {% endif %}

                        {% if ticket.reply %}
                        <div class="agent-reply-title" style="margin-top: 2rem;">Agent Reply</div>
                        <div class="detail-box" style="background-color: #f0f7ff; border-color: #cce5ff;">
                            <p>{{ ticket.reply }}</p>
                        </div>
                        {% elif ticket.status == 'resolved' %}
                        <div class="form-success">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                                stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M5 13l4 4L19 7" />
                            </svg>
                            <p>This ticket has been marked as resolved.</p>
                        </div>
                        {% else %}
                        <div class="pending-notice">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                                stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                            </svg>
                            <p>Your report is being reviewed.<br>An agent will respond shortly.</p>
                        </div>
                        {% endif %}
                    </div>
                    {% else %}
                    <div id="ticket-detail-content">
                        <p class="select-ticket-msg">No tickets selected.</p>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>

        <!-- Live Chats Page -->
        <div id="live-chats-page" class="page">
            <!-- Chat List View -->
            <div id="chat-list-view" class="chat-view active">
                <div class="chat-list-header">
                    <div>
                        <h2 class="content-title">Live Chats</h2>
                        <p class="page-subtitle">View your conversations with support</p>
                    </div>
                    <button class="new-chat-btn" id="start-new-chat">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <line x1="12" y1="5" x2="12" y2="19" />
                            <line x1="5" y1="12" x2="19" y2="12" />
                        </svg>
                        Start New Chat
                    </button>
                </div>
                <div class="divider"></div>

                <div class="chat-list">
                    <div class="chat-list-item" data-chat="1">
                        <div class="chat-list-avatar">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none"
                                stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2" />
                                <circle cx="12" cy="7" r="4" />
                            </svg>
                        </div>
                        <div class="chat-list-info">
                            <div class="chat-list-top">
                                <h4 class="chat-list-name">Chan Yi Liang</h4>
                                <span class="chat-list-time">Today, 2:30 PM</span>
                            </div>
                            <p class="chat-list-preview">I'll look into the points issue for you right away.</p>
                            <div class="chat-list-meta">
                                <span class="chat-status status-ongoing">Ongoing</span>
                                <span class="chat-duration">5 messages</span>
                            </div>
                        </div>
                    </div>

                    <div class="chat-list-item" data-chat="2">
                        <div class="chat-list-avatar">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none"
                                stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2" />
                                <circle cx="12" cy="7" r="4" />
                            </svg>
                        </div>
                        <div class="chat-list-info">
                            <div class="chat-list-top">
                                <h4 class="chat-list-name">Jayden Yip</h4>
                                <span class="chat-list-time">Yesterday, 10:15 AM</span>
                            </div>
                            <p class="chat-list-preview">Your event registration has been confirmed. See you there!</p>
                            <div class="chat-list-meta">
                                <span class="chat-status status-resolved">Resolved</span>
                                <span class="chat-duration">8 messages</span>
                            </div>
                        </div>
                    </div>

                    <div class="chat-list-item" data-chat="3">
                        <div class="chat-list-avatar">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none"
                                stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2" />
                                <circle cx="12" cy="7" r="4" />
                            </svg>
                        </div>
                        <div class="chat-list-info">
                            <div class="chat-list-top">
                                <h4 class="chat-list-name">Caius Chan</h4>
                                <span class="chat-list-time">Jan 15, 2025</span>
                            </div>
                            <p class="chat-list-preview">Your account has been verified successfully. You're all set!
                            </p>
                            <div class="chat-list-meta">
                                <span class="chat-status status-resolved">Resolved</span>
                                <span class="chat-duration">6 messages</span>
                            </div>
                        </div>
                    </div>

                    <div class="chat-list-item" data-chat="4">
                        <div class="chat-list-avatar">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none"
                                stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2" />
                                <circle cx="12" cy="7" r="4" />
                            </svg>
                        </div>
                        <div class="chat-list-info">
                            <div class="chat-list-top">
                                <h4 class="chat-list-name">Dickson Lim</h4>
                                <span class="chat-list-time">Jan 10, 2025</span>
                            </div>
                            <p class="chat-list-preview">We're still looking into your refund request. I'll update you
                                shortly.</p>
                            <div class="chat-list-meta">
                                <span class="chat-status status-ongoing">Ongoing</span>
                                <span class="chat-duration">4 messages</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Chat Conversation View -->
            <div id="chat-conversation-view" class="chat-view">
                <a href="#" class="chat-back-link" id="back-to-chat-list">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                        stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <line x1="19" y1="12" x2="5" y2="12" />
                        <polyline points="12 19 5 12 12 5" />
                    </svg>
                    Back to Chats
                </a>

                <div class="chat-container">
                    <div class="chat-header">
                        <div class="chat-user-info">
                            <div class="chat-avatar">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none"
                                    stroke="currentColor" stroke-width="1.5" stroke-linecap="round"
                                    stroke-linejoin="round">
                                    <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2" />
                                    <circle cx="12" cy="7" r="4" />
                                </svg>
                            </div>
                            <div class="chat-user-details">
                                <h4 class="chat-user-name">Support Agent</h4>
                                <p class="chat-duration">Select a chat to view</p>
                            </div>
                        </div>
                        <button class="end-chat-btn">End Chat</button>
                    </div>

                    <div class="chat-body">
                        <div class="chat-messages">
                            <!-- Messages will be loaded dynamically -->
                        </div>

                        <div class="chat-input-area">
                            <button class="attachment-btn">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none"
                                    stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                    stroke-linejoin="round">
                                    <path
                                        d="M21.44 11.05l-9.19 9.19a6 6 0 0 1-8.49-8.49l9.19-9.19a4 4 0 0 1 5.66 5.66l-9.2 9.19a2 2 0 0 1-2.83-2.83l8.49-8.48" />
                                </svg>
                            </button>
                            <input type="text" class="chat-input" placeholder="Type your message">
                            <button class="send-btn">Send Reply</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>
</div>

<script src="{{ url_for('static', filename='js/youth/support.js') }}"></script>
{% endblock %}