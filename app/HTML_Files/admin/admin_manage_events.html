<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Page - Event Management</title>

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">

    <!-- Admin CSS -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/admin/admin.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/admin/manage_events.css') }}">
</head>

<body>
    <!-- Sidebar -->
    <div class="sidebar">
        <div class="logo">
            <i class="bi bi-shield-check"></i> SkillSwap Admin
        </div>
        <nav>
            <a href="{{ url_for('admin.admin_dashboard') }}" class="nav-item">
                <i class="bi bi-speedometer2"></i> Dashboard
            </a>
            <a href="{{ url_for('admin.admin_manage_users') }}" class="nav-item">
                <i class="bi bi-people"></i> User Management
            </a>
            <a href="{{ url_for('admin.admin_manage_events') }}" class="nav-item active">
                <i class="bi bi-calendar-event"></i> Events
            </a>
            <a href="{{ url_for('admin.admin_manage_rewards') }}" class="nav-item">
                <i class="bi bi-gift"></i> Rewards
            </a>
            <a href="{{ url_for('admin.admin_support_tickets') }}" class="nav-item">
                <i class="bi bi-headset"></i> Support Tickets
            </a>
        </nav>
    </div>

    <!-- Main Content -->
    <div class="main">
        <!-- Flash Messages -->
        {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
        <div style="margin-bottom: 20px;">
            {% for category, message in messages %}
            <div class="alert alert-{{ category }}">{{ message }}</div>
            {% endfor %}
        </div>
        {% endif %}
        {% endwith %}

        <h1 class="page-title">Event Management</h1>

        <!-- Filter Tabs and New Event Button -->
        <div class="controls-row">
            <div class="filter-tabs">
                <a href="{{ url_for('admin.admin_manage_events', filter='pending') }}"
                    class="filter-tab {% if current_filter == 'pending' %}active{% endif %}">Pending</a>
                <a href="{{ url_for('admin.admin_manage_events', filter='approved') }}"
                    class="filter-tab {% if current_filter == 'approved' %}active{% endif %}">Approved</a>
                <a href="{{ url_for('admin.admin_manage_events', filter='past') }}"
                    class="filter-tab {% if current_filter == 'past' %}active{% endif %}">Past</a>
            </div>
            <button class="btn-new-event" onclick="openCreateModal()">New Event +</button>
        </div>

        <!-- Events Table -->
        <div class="table-container">
            <table class="events-table">
                <thead>
                    <tr>
                        <th>Event Title</th>
                        <th>Date</th>
                        <th>Status</th>
                        <th>Location</th>
                        <th>Manpower</th>
                        <th>Participants</th>
                        <th>Category</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for event in events %}
                    <tr>
                        <td>{{ event.title }}</td>
                        <td>{{ event.start_datetime[:10] if event.start_datetime else 'N/A' }}</td>
                        <td>
                            {% if current_filter == 'pending' %}
                            <!-- Force "Pending" display for pending tab items as requested -->
                            <span class="status-badge pending">Pending</span>
                            {% elif current_filter == 'past' %}
                            <!-- Force "Finished" display for past tab items as requested -->
                            <span class="status-badge finished">Finished</span>
                            {% else %}
                            <!-- Default display logic for 'All' or 'Approved' tabs -->
                            {% if event.status == 'open' %}
                            <span class="status-badge approved">Approved</span>
                            {% elif event.status == 'cancelled' %}
                            <span class="status-badge cancelled">Cancelled</span>
                            {% else %}
                            <span class="status-badge pending">{{ event.status|capitalize }}</span>
                            {% endif %}
                            {% endif %}
                        </td>
                        <td>{{ event.location or 'N/A' }}</td>
                        <td>{{ event.manpower_required or 0 }}M{{ event.participant_count or 0 }}B</td>
                        <td>{{ event.participant_count or 0 }} users</td>
                        <td>{{ category_display.get(event.category, event.category) if event.category else 'N/A' }}</td>
                        <td class="actions-cell">
                            <button class="action-icon edit edit-event-btn" data-event-id="{{ event.event_id }}"
                                data-title="{{ event.title|e }}" data-datetime="{{ event.start_datetime }}"
                                data-location="{{ event.location|e }}" data-category="{{ event.category }}"
                                data-status="{{ event.status }}" data-led-by="{{ event.led_by }}"
                                data-max-capacity="{{ event.max_capacity or '' }}">
                                <i class="bi bi-pencil-square"></i>
                            </button>
                            <form action="{{ url_for('admin.admin_delete_event', event_id=event.event_id) }}"
                                method="POST" style="display:inline;"
                                onsubmit="return confirm('Are you sure you want to delete this event?');">
                                <button type="submit" class="action-icon delete">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </form>
                        </td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="8" style="text-align: center; color: #9ca3af; padding: 40px;">
                            No events found for this filter.
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- Create Event Modal -->
    <div id="createModal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Create New Event</h2>
                <button class="modal-close" onclick="closeCreateModal()">&times;</button>
            </div>
            <form action="{{ url_for('admin.create_event') }}" method="POST">
                <div class="form-grid">
                    <div class="form-group">
                        <label class="form-label">Event Title</label>
                        <input type="text" name="title" class="form-input" placeholder="Enter event title" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Location</label>
                        <input type="text" name="location" class="form-input" placeholder="Event location" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Start Date/Time</label>
                        <input type="datetime-local" name="start_datetime" class="form-input" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Category</label>
                        <select name="category" class="form-input">
                            <option value="social_games">üé≤ Social & Games</option>
                            <option value="tech_digital">üñ•Ô∏è Tech & Digital</option>
                            <option value="life_skills">üç≥ Life Skills</option>
                            <option value="health_wellness">üßò Health & Wellness</option>
                            <option value="culture_creative">üé® Culture & Creative</option>
                            <option value="community_projects">üõ†Ô∏è Community Projects</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Led By</label>
                        <select name="led_by" class="form-input">
                            <option value="employee">Employee</option>
                            <option value="youth">Youth</option>
                            <option value="senior">Senior</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Max Capacity</label>
                        <input type="number" name="max_capacity" class="form-input" placeholder="Optional">
                    </div>
                    <div class="form-group">
                        <label class="form-label">GRC</label>
                        <select name="grc_id" class="form-input">
                            <option value="">Select GRC (Optional)</option>
                            {% for grc in grcs %}
                            <option value="{{ grc.grc_id }}">{{ grc.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Description</label>
                    <textarea name="description" class="form-input" rows="3" placeholder="Event description"></textarea>
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn-cancel" onclick="closeCreateModal()">Cancel</button>
                    <button type="submit" class="btn-submit">Create Event</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Edit Event Modal -->
    <div id="editModal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Edit Event</h2>
                <button class="modal-close" onclick="closeEditModal()">&times;</button>
            </div>
            <form id="editForm" action="" method="POST">
                <div class="form-grid">
                    <div class="form-group">
                        <label class="form-label">Event Title</label>
                        <input type="text" name="title" id="edit_title" class="form-input" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Location</label>
                        <input type="text" name="location" id="edit_location" class="form-input" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Start Date/Time</label>
                        <input type="datetime-local" name="start_datetime" id="edit_datetime" class="form-input"
                            required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Category</label>
                        <select name="category" id="edit_category" class="form-input">
                            <option value="social_games">üé≤ Social & Games</option>
                            <option value="tech_digital">üñ•Ô∏è Tech & Digital</option>
                            <option value="life_skills">üç≥ Life Skills</option>
                            <option value="health_wellness">üßò Health & Wellness</option>
                            <option value="culture_creative">üé® Culture & Creative</option>
                            <option value="community_projects">üõ†Ô∏è Community Projects</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Status</label>
                        <select name="status" id="edit_status" class="form-input">
                            <option value="open">Open</option>
                            <option value="closed">Closed</option>
                            <option value="cancelled">Cancelled</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Led By</label>
                        <select name="led_by" id="edit_led_by" class="form-input">
                            <option value="employee">Employee</option>
                            <option value="youth">Youth</option>
                            <option value="senior">Senior</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Max Capacity</label>
                        <input type="number" name="max_capacity" id="edit_max_capacity" class="form-input"
                            placeholder="Optional">
                    </div>
                    <div class="form-group">
                        <label class="form-label">GRC</label>
                        <select name="grc_id" id="edit_grc" class="form-input">
                            <option value="">Select GRC (Optional)</option>
                            {% for grc in grcs %}
                            <option value="{{ grc.grc_id }}">{{ grc.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Description</label>
                    <textarea name="description" id="edit_description" class="form-input" rows="3"></textarea>
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn-cancel" onclick="closeEditModal()">Cancel</button>
                    <button type="submit" class="btn-submit">Update Event</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Admin JS -->
    <script src="{{ url_for('static', filename='js/admin/manage_events.js') }}"></script>
</body>

</html>