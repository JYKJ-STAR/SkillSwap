<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Page - Event Management</title>

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">

    <!-- Admin CSS -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/admin/admin.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/admin/manage_events.css') }}">
</head>

<body>
    <!-- Sidebar -->
    <div class="sidebar" style="display: flex; flex-direction: column;">
        <div class="logo">
            <i class="bi bi-shield-check"></i> SkillSwap Admin
        </div>

        <div class="sidebar-profile-info"
            style="padding: 0 15px 20px; border-bottom: 1px solid #374151; margin-bottom: 20px;">
            <div style="color: #fff; font-weight: 600;">{{ user_name }}</div>
            <div style="color: #9ca3af; font-size: 0.85em;">{{ admin_email }}</div>
        </div>

        <nav style="flex: 1;">
            <a href="{{ url_for('admin.admin_dashboard') }}" class="nav-item">
                <i class="bi bi-speedometer2"></i> Dashboard
            </a>
            <a href="{{ url_for('admin.admin_manage_users') }}" class="nav-item">
                <i class="bi bi-people"></i> User Management
            </a>
            <a href="{{ url_for('admin.admin_manage_events') }}" class="nav-item active">
                <i class="bi bi-calendar-event"></i> Events
            </a>
            <a href="{{ url_for('admin.admin_manage_rewards') }}" class="nav-item">
                <i class="bi bi-gift"></i> Rewards
            </a>
            <a href="{{ url_for('admin.admin_support_tickets') }}" class="nav-item">
                <i class="bi bi-headset"></i> Support Request
            </a>
        </nav>

        <div class="sidebar-footer">
            <a href="{{ url_for('admin.admin_logout') }}" class="nav-item nav-logout">
                <i class="bi bi-box-arrow-right"></i> Logout
            </a>
        </div>
    </div>

    <!-- Main Content -->
    <div class="main">
        <!-- Flash Messages -->
        {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
        <div style="margin-bottom: 20px;">
            {% for category, message in messages %}
            <div class="alert alert-{{ category }}">{{ message }}</div>
            {% endfor %}
        </div>
        {% endif %}
        {% endwith %}

        <h1 class="page-title">Event Management</h1>

        <!-- Filter Tabs and New Event Button -->
        <div class="controls-row">
            <div class="filter-tabs">
                <a href="{{ url_for('admin.admin_manage_events', filter='pending') }}"
                    class="filter-tab {% if current_filter == 'pending' %}active{% endif %}">Pending</a>
                <a href="{{ url_for('admin.admin_manage_events', filter='approved') }}"
                    class="filter-tab {% if current_filter == 'approved' %}active{% endif %}">Approved</a>
                <a href="{{ url_for('admin.admin_manage_events', filter='past') }}"
                    class="filter-tab {% if current_filter == 'past' %}active{% endif %}">Ended </a>
                <a href="{{ url_for('admin.admin_manage_events', filter='voided') }}"
                    class="filter-tab {% if current_filter == 'voided' %}active{% endif %}">Voided</a>
            </div>

            <!-- Search Bar (Right Aligned) -->
            <div style="display: flex; gap: 10px; align-items: center;">
                {% if current_filter == 'approved' %}
                <form action="{{ url_for('admin.admin_manage_events') }}" method="GET" class="search-form"
                    style="position: relative;">
                    <input type="hidden" name="filter" value="{{ current_filter }}">
                    <input type="text" name="search" placeholder="Search events..." value="{{ search_query }}"
                        style="padding: 10px 15px 10px 35px; border-radius: 8px; border: 1px solid #4b5563; background: #374151; color: white; width: 250px;">
                    <i class="bi bi-search"
                        style="position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: #9ca3af;"></i>
                    {% if search_query %}
                    <a href="{{ url_for('admin.admin_manage_events', filter=current_filter) }}"
                        style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%); color: #9ca3af; text-decoration: none;">
                        <i class="bi bi-x-circle-fill"></i>
                    </a>
                    {% endif %}
                </form>
                {% endif %}

                {% if current_filter == 'pending' %}
                <button class="btn-new-event" onclick="openCreateModal()">New Event +</button>
                {% elif current_filter in ['voided', 'past'] and events %}
                <form action="{{ url_for('admin.admin_clear_tab', tab_name=current_filter) }}" method="POST"
                    style="display:inline;"
                    onsubmit="return confirm('Are you sure you want to clear all {{ current_filter }} events from view? Data will be preserved.');">
                    <button type="submit" class="btn-new-event" style="background: #6b7280;">
                        <i class="bi bi-trash"></i> Clear All
                    </button>
                </form>
                {% endif %}
            </div>
        </div>

        <!-- Events Table -->
        <div class="table-container">
            <table class="events-table">
                <thead>
                    <tr>
                        <th>Event Title</th>
                        <th>Date</th>
                        <th>Status</th>
                        <th>Location</th>
                        <th>Participants</th>
                        <th>Category</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% if current_filter == 'approved' %}
                    {# Group by category with headers for Approved tab #}
                    {% if events %}
                    {% set current_category = namespace(value='') %}
                    {% set current_status_group = namespace(value='') %}
                    {% for event in events %}
                    {# Determine status group #}
                    {% set status_group = 'Published' if event.status == 'published' else 'Unpublished' %}

                    {# Show status group header when it changes #}
                    {% if status_group != current_status_group.value %}
                    {% set current_status_group.value = status_group %}
                    {% set current_category.value = '' %}
                    <tr class="category-header-row">
                        <td colspan="7"
                            style="background: #1f2937; padding: 15px 20px; font-weight: 700; font-size: 1.1em; color: #60a5fa; border-top: 2px solid #4b5563;">
                            {{ 'üåê Published Events' if status_group == 'Published' else 'üìù Unpublished Events' }}
                        </td>
                    </tr>
                    {% endif %}

                    {# Show category header when category changes #}
                    {% if event.category != current_category.value %}
                    {% set current_category.value = event.category %}
                    <tr class="category-subheader-row">
                        <td colspan="7"
                            style="background: #374151; padding: 12px 20px; font-weight: 600; font-size: 0.95em; color: #d1d5db; border-left: 4px solid #ef4444;">
                            {{ category_display.get(event.category, event.category) }}
                        </td>
                    </tr>
                    {% endif %}

                    <tr>
                        <td>{{ event.title }}</td>
                        <td>{{ event.start_datetime[:10] if event.start_datetime else 'N/A' }}</td>
                        <td>
                            {% if event.status == 'published' %}
                            <span class="status-badge published">Published</span>
                            {% else %}
                            <span class="status-badge approved">Approved (Unpublished)</span>
                            {% endif %}
                        </td>
                        <td>{{ event.location or 'N/A' }}</td>
                        <td>
                            {% if event.status == 'published' %}
                            <a href="{{ url_for('admin.admin_view_participants', event_id=event.event_id) }}"
                                style="color: #60a5fa; text-decoration: none; display: inline-flex; align-items: center; gap: 5px; transition: color 0.2s;"
                                onmouseover="this.style.color='#93c5fd'" onmouseout="this.style.color='#60a5fa'">
                                <i class="bi bi-people-fill"></i>
                                {{ event.participant_count or 0 }} users
                                <i class="bi bi-box-arrow-up-right" style="font-size: 0.75em;"></i>
                            </a>
                            {% else %}
                            {{ event.participant_count or 0 }} users
                            {% endif %}
                        </td>
                        <td>{{ category_display.get(event.category, event.category) if event.category else 'N/A' }}</td>
                        <td class="actions-cell">
                            {% if event.status == 'approved' %}
                            <form action="{{ url_for('admin.admin_publish_event', event_id=event.event_id) }}"
                                method="POST" style="display:inline;">
                                <button type="submit" class="action-icon publish" title="Publish"><i
                                        class="bi bi-globe"></i></button>
                            </form>
                            {% endif %}

                            <button class="action-icon void" title="Void"
                                data-void-url="{{ url_for('admin.admin_void_event', event_id=event.event_id) }}"
                                onclick="openVoidModal(this.dataset.voidUrl)">
                                <i class="bi bi-x-circle"></i>
                            </button>
                            <form action="{{ url_for('admin.admin_end_event', event_id=event.event_id) }}" method="POST"
                                style="display:inline;">
                                <button type="submit" class="action-icon end" title="End Event"><i
                                        class="bi bi-flag-fill"></i></button>
                            </form>
                        </td>
                    </tr>
                    {% endfor %}
                    {% else %}
                    <tr>
                        <td colspan="7" style="text-align: center; color: #9ca3af; padding: 40px;">No events found for
                            this filter.</td>
                    </tr>
                    {% endif %}

                    {% else %}
                    {# Standard table for other tabs #}
                    {% if events %}
                    {% for event in events %}
                    <tr>
                        <td>{{ event.title }}</td>
                        <td>{{ event.start_datetime[:10] if event.start_datetime else 'N/A' }}</td>
                        <td>
                            {% if current_filter == 'pending' %}
                            <span class="new-badge">NEW</span><span class="status-badge pending">Pending</span>
                            {% elif current_filter == 'past' %}
                            <span class="status-badge finished">Finished</span>
                            {% elif current_filter == 'voided' %}
                            <span class="status-badge voided">Voided</span>
                            {% if event.void_reason %}
                            <div style="font-size: 0.8em; color: #9ca3af; margin-top: 5px;">Reason: {{ event.void_reason
                                }}</div>
                            {% endif %}
                            {% else %}
                            <span class="status-badge">{{ event.status|capitalize }}</span>
                            {% endif %}
                        </td>
                        <td>{{ event.location or 'N/A' }}</td>
                        <td>{{ event.participant_count or 0 }} users</td>
                        <td>{{ category_display.get(event.category, event.category) if event.category else 'N/A' }}</td>
                        <td class="actions-cell">
                            {% if current_filter == 'pending' %}
                            <form action="{{ url_for('admin.admin_approve_event', event_id=event.event_id) }}"
                                method="POST" style="display:inline;">
                                <button type="submit" class="action-icon approve" title="Approve"><i
                                        class="bi bi-check-lg"></i></button>
                            </form>
                            <button class="action-icon edit edit-event-btn" data-event-id="{{ event.event_id }}"
                                data-title="{{ event.title|e }}" data-datetime="{{ event.start_datetime }}"
                                data-location="{{ event.location|e }}" data-category="{{ event.category }}"
                                data-status="{{ event.status }}" data-led-by="{{ event.led_by }}"
                                data-max-capacity="{{ event.max_capacity or '' }}"
                                data-description="{{ event.description|e }}" data-grc-id="{{ event.grc_id }}"
                                title="Edit"><i class="bi bi-pencil-square"></i></button>
                            <form action="{{ url_for('admin.admin_delete_event', event_id=event.event_id) }}"
                                method="POST" style="display:inline;"
                                onsubmit="return confirm('Are you sure you want to delete this event?');">
                                <button type="submit" class="action-icon delete" title="Delete"><i
                                        class="bi bi-trash"></i></button>
                            </form>
                            {% elif current_filter == 'past' or current_filter == 'voided' %}
                            <span style="color: #6b7280;">‚Äî</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                    {% else %}
                    <tr>
                        <td colspan="7" style="text-align: center; color: #9ca3af; padding: 40px;">No events found for
                            this filter.</td>
                    </tr>
                    {% endif %}
                    {% endif %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- Create Event Modal -->
    <div id="createModal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Create New Event</h2>
                <button class="modal-close" onclick="closeCreateModal()">&times;</button>
            </div>
            <form action="{{ url_for('admin.create_event') }}" method="POST">
                <div class="form-grid">
                    <div class="form-group">
                        <label class="form-label">Event Title</label>
                        <input type="text" name="title" class="form-input" placeholder="Enter event title" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Max Capacity</label>
                        <input type="number" name="max_capacity" class="form-input" placeholder="Optional">
                    </div>
                    <div class="form-group">
                        <label class="form-label">GRC</label>
                        <select name="grc_id" id="create_grc" class="form-input"
                            onchange="updateLocationOptions(this.value, 'create_location')">
                            <option value="">Select GRC (Required for Location)</option>
                            {% for grc in grcs %}
                            <option value="{{ grc.grc_id }}">{{ grc.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Location</label>
                        <select name="location" id="create_location" class="form-input" required>
                            <option value="">Select GRC first</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Start Date/Time</label>
                        <input type="datetime-local" name="start_datetime" class="form-input" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Category</label>
                        <select name="category" class="form-input">
                            <option value="social_games">üé≤ Social & Games</option>
                            <option value="tech_digital">üñ•Ô∏è Tech & Digital</option>
                            <option value="life_skills">üç≥ Life Skills</option>
                            <option value="health_wellness">üßò Health & Wellness</option>
                            <option value="culture_creative">üé® Culture & Creative</option>
                            <option value="community_projects">üõ†Ô∏è Community Projects</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Led By</label>
                        <select name="led_by" class="form-input">
                            <option value="employee">Employee</option>
                            <option value="youth">Youth</option>
                            <option value="senior">Senior</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Description</label>
                    <textarea name="description" class="form-input" rows="3" placeholder="Event description"></textarea>
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn-cancel" onclick="closeCreateModal()">Cancel</button>
                    <button type="submit" class="btn-submit">Create Event</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Edit Event Modal -->
    <div id="editModal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Edit Event</h2>
                <button class="modal-close" onclick="closeEditModal()">&times;</button>
            </div>
            <form id="editForm" action="" method="POST">
                <div class="form-grid">
                    <div class="form-group">
                        <label class="form-label">Event Title</label>
                        <input type="text" name="title" id="edit_title" class="form-input" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Location</label>
                        <input type="text" name="location" id="edit_location" class="form-input" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Start Date/Time</label>
                        <input type="datetime-local" name="start_datetime" id="edit_datetime" class="form-input"
                            required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Category</label>
                        <select name="category" id="edit_category" class="form-input">
                            <option value="social_games">üé≤ Social & Games</option>
                            <option value="tech_digital">üñ•Ô∏è Tech & Digital</option>
                            <option value="life_skills">üç≥ Life Skills</option>
                            <option value="health_wellness">üßò Health & Wellness</option>
                            <option value="culture_creative">üé® Culture & Creative</option>
                            <option value="community_projects">üõ†Ô∏è Community Projects</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Status</label>
                        <select name="status" id="edit_status" class="form-input">
                            <option value="open">Open</option>
                            <option value="closed">Closed</option>
                            <option value="cancelled">Cancelled</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Led By</label>
                        <select name="led_by" id="edit_led_by" class="form-input">
                            <option value="employee">Employee</option>
                            <option value="youth">Youth</option>
                            <option value="senior">Senior</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Max Capacity</label>
                        <input type="number" name="max_capacity" id="edit_max_capacity" class="form-input"
                            placeholder="Optional">
                    </div>
                    <div class="form-group">
                        <label class="form-label">GRC</label>
                        <select name="grc_id" id="edit_grc" class="form-input">
                            <option value="">Select GRC (Optional)</option>
                            {% for grc in grcs %}
                            <option value="{{ grc.grc_id }}">{{ grc.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Description</label>
                    <textarea name="description" id="edit_description" class="form-input" rows="3"></textarea>
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn-cancel" onclick="closeEditModal()">Cancel</button>
                    <button type="submit" class="btn-submit">Update Event</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Void Reason Modal -->
    <div id="voidModal" class="modal-overlay">
        <div class="modal-content" style="max-width: 500px; background: #8a8a8a;">
            <div class="modal-header" style="border-bottom: none; padding-bottom: 10px;">
                <h2 style="color: #1a1a1a; font-size: 1.5em; font-weight: 600;">Remove Event?</h2>
                <button class="modal-close" onclick="closeVoidModal()" style="color: #1a1a1a;">&times;</button>
            </div>
            <form id="voidForm" action="" method="POST">
                <div class="form-group" style="margin-bottom: 15px;">
                    <label class="form-label"
                        style="display: flex; align-items: center; gap: 8px; font-size: 0.9em; margin-bottom: 8px; color: #1a1a1a;">
                        <input type="checkbox" name="notify_users" value="yes" checked
                            style="width: 16px; height: 16px;">
                        Notify all mentors and mentees?
                    </label>
                    <label class="form-label"
                        style="font-size: 0.75em; color: #1a1a1a; margin-bottom: 5px;">Reasoning</label>
                    <textarea name="void_reason" class="form-input" rows="3" placeholder=""
                        style="background: #6b6b6b; border: 1px solid #5a5a5a; color: #fff; font-size: 0.85em;"></textarea>
                </div>
                <div class="modal-actions" style="gap: 15px;">
                    <button type="button" class="btn-cancel" onclick="closeVoidModal()"
                        style="background: #b8b8b8; color: #1a1a1a; flex: 1; padding: 10px;">Return</button>
                    <button type="submit" class="btn-submit"
                        style="background-color: #4a4a4a; color: #fff; flex: 1; padding: 10px;">Yes Remove
                        Event</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Admin JS -->
    <script>
        // GRC Locations Map from Backend
        const GRC_LOCATIONS = {
            1: ['Toa Payoh CC', 'Toa Payoh Stadium', 'Toa Payoh Library'],
            2: ['Bishan CC', 'Bishan Sports Hall', 'Bishan Park'],
            3: ['Ang Mo Kio CC', 'Ang Mo Kio Hub', 'Bishan-Ang Mo Kio Park'],
            4: ['Tampines Hub', 'Tampines CC', 'Tampines Regional Library'],
            5: ['Jurong The Frontier CC', 'Jurong Lake Gardens', 'Jurong Regional Library'],
            6: ['Yishun CC', 'Yishun Park', 'Northpoint City Community Space'],
            7: ['Punggol CC', 'Punggol Community Garden', 'One Punggol'],
            8: ['Bedok CC', 'Bedok Reservoir', 'Heartbeat @ Bedok']
        };

        function updateLocationOptions(grcId, locationSelectId) {
            const select = document.getElementById(locationSelectId);
            select.innerHTML = '<option value="">Select Location</option>';

            if (grcId && GRC_LOCATIONS[grcId]) {
                GRC_LOCATIONS[grcId].forEach(loc => {
                    const option = document.createElement('option');
                    option.value = loc;
                    option.textContent = loc;
                    select.appendChild(option);
                });
            } else {
                select.innerHTML = '<option value="">Select GRC first</option>';
            }
        }

        function openVoidModal(url) {
            document.getElementById('voidForm').action = url;
            document.getElementById('voidModal').classList.add('active');
        }

        function closeVoidModal() {
            document.getElementById('voidModal').classList.remove('active');
        }
    </script>
    <script src="{{ url_for('static', filename='js/admin/manage_events.js') }}"></script>
</body>

</html>