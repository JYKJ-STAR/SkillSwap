<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manage Rewards - SkillSwap Admin</title>

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">

    <!-- Admin CSS -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/admin/admin.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/admin/manage_events.css') }}">
</head>

<body>
    <!-- Sidebar -->
    <div class="sidebar" style="display: flex; flex-direction: column;">
        <div class="logo">
            <i class="bi bi-shield-check"></i> SkillSwap Admin
        </div>
        <div class="sidebar-profile-unified">
            {% if admin_photo %}
            <img src="{{ url_for('static', filename='img/admin/' + admin_photo) }}" class="sidebar-avatar" alt="Admin">
            {% else %}
            <div class="sidebar-avatar"
                style="display: flex; align-items: center; justify-content: center; font-size: 1.5em; color: #9ca3af;">
                <i class="bi bi-person-fill"></i>
            </div>
            {% endif %}
            <div class="sidebar-user-details">
                <div class="sidebar-user-name">{{ user_name }}</div>
                <div class="sidebar-user-email">{{ admin_email }}</div>
            </div>
        </div>
        <nav style="flex: 1;">
            <a href="{{ url_for('admin.admin_dashboard') }}" class="nav-item">
                <i class="bi bi-speedometer2"></i> Dashboard
            </a>
            <a href="{{ url_for('admin.admin_manage_users') }}" class="nav-item">
                <i class="bi bi-people"></i> User Management
            </a>
            <a href="{{ url_for('admin.admin_manage_events') }}" class="nav-item">
                <i class="bi bi-calendar-event"></i> Events
            </a>
            <a href="{{ url_for('admin.admin_manage_rewards') }}" class="nav-item active">
                <i class="bi bi-gift"></i> Rewards
            </a>
            <a href="{{ url_for('admin.admin_support_tickets') }}" class="nav-item">
                <i class="bi bi-headset"></i> Support Request
            </a>
        </nav>

        <div class="sidebar-footer">
            <a href="{{ url_for('admin.admin_logout') }}" class="nav-item nav-logout">
                <i class="bi bi-box-arrow-right"></i> Logout
            </a>
        </div>
    </div>

    <!-- Main Content -->
    <div class="main">
        <h1 class="page-title">Manage Rewards</h1>

        <!-- Main Section Tabs -->
        <div class="controls-row">
            <div class="filter-tabs" id="sectionTabs">
                <button class="filter-tab active" data-section="verification">User Verification</button>
                <button class="filter-tab" data-section="rewards">Rewards</button>
            </div>
        </div>

        <!-- USER VERIFICATION SECTION -->
        <div class="section-content active" id="verification-section">
            <h2 style="color:white; margin-bottom:20px; font-size: 1.3em;">Pending Event Verifications</h2>

            {% if pending_proofs %}
            <div class="table-container">
                <table class="events-table">
                    <thead>
                        <tr>
                            <th>User</th>
                            <th>Event</th>
                            <th>Proof</th>
                            <th>Feedback</th>
                            <th>Points</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for proof in pending_proofs %}
                        <tr>
                            <td><strong>{{ proof.user_name }}</strong></td>
                            <td>{{ proof.event_title }}</td>
                            <td>
                                <a href="{{ url_for('static', filename='img/users/Upload_proof/' + proof.proof_media_url) }}"
                                    target="_blank">
                                    <img src="{{ url_for('static', filename='img/users/Upload_proof/' + proof.proof_media_url) }}"
                                        style="height:50px; border-radius:4px; border:1px solid #4b5563;" alt="Proof">
                                </a>
                            </td>
                            <td>
                                <span
                                    style="color: #d1d5db; font-size: 0.9em; max-width: 200px; display: inline-block; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;"
                                    title="{{ proof.proof_description or 'No feedback provided' }}">
                                    {{ proof.proof_description or 'No feedback' }}
                                </span>
                            </td>
                            <td><span class="status-badge published">+{{ proof.base_points_participant or 100 }}</span>
                            </td>
                            <td class="actions-cell">
                                <form
                                    action="{{ url_for('admin.admin_verify_proof', event_id=proof.event_id, user_id=proof.user_id) }}"
                                    method="POST" style="display:inline;">
                                    <button type="submit" class="action-icon approve" title="Approve">
                                        <i class="bi bi-check-circle"></i>
                                    </button>
                                </form>
                                <form
                                    action="{{ url_for('admin.admin_reject_proof', event_id=proof.event_id, user_id=proof.user_id) }}"
                                    method="POST" style="display:inline; margin-left:5px;">
                                    <button type="submit" class="action-icon delete" title="Reject">
                                        <i class="bi bi-x-circle"></i>
                                    </button>
                                </form>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <p style="color:#9ca3af; background:#1f2937; padding:20px; border-radius:8px;">No pending verifications.</p>
            {% endif %}
        </div>

        <!-- REWARDS SECTION -->
        <div class="section-content" id="rewards-section">
            <!-- Sub-tabs for Rewards -->
            <div class="controls-row" style="margin-bottom: 20px;">
                <div class="filter-tabs" id="rewardsTabs">
                    <button class="filter-tab active" data-tab="manage">Manage Rewards</button>
                    <button class="filter-tab" data-tab="approval">Rewards Approval</button>
                    <button class="filter-tab" data-tab="redeemed">Redeemed Rewards</button>
                </div>
            </div>

            <!-- Manage Rewards Tab -->
            <div class="tab-content active" id="manage-tab">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2 style="color:white; font-size: 1.3em; margin: 0;">Rewards Catalog</h2>
                    <button class="btn-submit" onclick="openAddRewardModal()" style="padding: 10px 20px;">
                        <i class="bi bi-plus-circle"></i> Add Reward
                    </button>
                </div>

                {% if rewards %}
                <div class="table-container">
                    <table class="events-table">
                        <thead>
                            <tr>
                                <th>Reward Name</th>
                                <th>Description</th>
                                <th>Points Required</th>
                                <th>Quantity</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for reward in rewards %}
                            <tr>
                                <td><strong>{{ reward.name }}</strong></td>
                                <td>{{ reward.description or 'N/A' }}</td>
                                <td><span class="status-badge published">{{ reward.points_required }} pts</span></td>
                                <td>{{ reward.total_quantity or 'âˆž' }}</td>
                                <td>
                                    {% if reward.is_active %}
                                    <span class="status-badge published">Active</span>
                                    {% else %}
                                    <span class="status-badge voided">Inactive</span>
                                    {% endif %}
                                </td>
                                <td class="actions-cell">
                                    <button class="action-icon edit edit-reward-btn" title="Edit Reward"
                                        data-reward-id="{{ reward.reward_id }}" data-name="{{ reward.name }}"
                                        data-description="{{ reward.description or '' }}"
                                        data-points="{{ reward.points_required }}"
                                        data-quantity="{{ reward.total_quantity or '' }}"
                                        data-active="{{ reward.is_active }}">
                                        <i class="bi bi-pencil-square"></i>
                                    </button>
                                    <button class="action-icon delete delete-reward-btn" title="Delete Reward"
                                        data-reward-id="{{ reward.reward_id }}" data-reward-name="{{ reward.name }}">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <p style="color:#9ca3af; background:#1f2937; padding:20px; border-radius:8px;">No rewards configured.
                </p>
                {% endif %}
            </div>

            <!-- Rewards Approval Tab -->
            <div class="tab-content" id="approval-tab">
                <h2 style="color:white; margin-bottom:20px; font-size: 1.3em;">Pending Reward Redemptions</h2>

                {% if pending_redemptions %}
                <div class="table-container">
                    <table class="events-table">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>User</th>
                                <th>Email</th>
                                <th>Reward</th>
                                <th>Points Required</th>
                                <th>User Points</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for redemption in pending_redemptions %}
                            <tr>
                                <td>{{ redemption.created_at[:10] if redemption.created_at else 'N/A' }}</td>
                                <td><strong>{{ redemption.user_name }}</strong></td>
                                <td>{{ redemption.user_email }}</td>
                                <td>{{ redemption.reward_name }}</td>
                                <td><span class="status-badge published">{{ redemption.points_required }} pts</span>
                                </td>
                                <td>
                                    {% if redemption.user_points >= redemption.points_required %}
                                    <span class="status-badge published">{{ redemption.user_points }} pts</span>
                                    {% else %}
                                    <span class="status-badge voided">{{ redemption.user_points }} pts
                                        (Insufficient)</span>
                                    {% endif %}
                                </td>
                                <td class="actions-cell">
                                    <form
                                        action="{{ url_for('admin.admin_approve_redemption', redemption_id=redemption.redemption_id) }}"
                                        method="POST" style="display:inline;">
                                        <button type="submit" class="action-icon approve" title="Approve" {% if
                                            redemption.user_points < redemption.points_required %}disabled{% endif %}>
                                            <i class="bi bi-check-circle"></i>
                                        </button>
                                    </form>
                                    <form
                                        action="{{ url_for('admin.admin_reject_redemption', redemption_id=redemption.redemption_id) }}"
                                        method="POST" style="display:inline; margin-left:5px;">
                                        <button type="submit" class="action-icon delete" title="Reject">
                                            <i class="bi bi-x-circle"></i>
                                        </button>
                                    </form>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <p style="color:#9ca3af; background:#1f2937; padding:20px; border-radius:8px;">No pending redemptions.
                </p>
                {% endif %}
            </div>

            <!-- Redeemed Rewards Tab -->
            <div class="tab-content" id="redeemed-tab">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2 style="color:white; margin: 0; font-size: 1.3em;">Redeemed Rewards History</h2>
                    <div class="filter-buttons" style="display: flex; gap: 10px;">
                        <button class="status-filter-btn active" data-status="all"
                            style="padding: 8px 16px; background: #3b82f6; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; transition: all 0.2s;">All</button>
                        <button class="status-filter-btn" data-status="approved"
                            style="padding: 8px 16px; background: #4b5563; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; transition: all 0.2s;">Pending
                            Claim</button>
                        <button class="status-filter-btn" data-status="redeemed"
                            style="padding: 8px 16px; background: #4b5563; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; transition: all 0.2s;">Claimed</button>
                    </div>
                </div>

                {% if redeemed_rewards %}
                <div class="table-container">
                    <table class="events-table">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>User</th>
                                <th>Email</th>
                                <th>Reward</th>
                                <th>Points Used</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for redemption in redeemed_rewards %}
                            <tr class="redeemed-row" data-status="{{ redemption.status }}">
                                <td>{{ redemption.created_at[:10] if redemption.created_at else 'N/A' }}</td>
                                <td><strong>{{ redemption.user_name }}</strong></td>
                                <td>{{ redemption.user_email }}</td>
                                <td>{{ redemption.reward_name }}</td>
                                <td><span class="status-badge published">{{ redemption.points_required }} pts</span>
                                </td>
                                <td>
                                    {% if redemption.status == 'redeemed' %}
                                    <span class="status-badge published">Claimed</span>
                                    {% elif redemption.status == 'approved' %}
                                    <span class="status-badge pending">Pending Claim</span>
                                    {% else %}
                                    <span class="status-badge voided">{{ redemption.status|capitalize }}</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <p style="color:#9ca3af; background:#1f2937; padding:20px; border-radius:8px;">No redeemed rewards yet.
                </p>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Add Reward Modal -->
    <div id="addRewardModal" class="modal-overlay">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h2>Add New Reward</h2>
                <button class="modal-close" onclick="closeAddRewardModal()">&times;</button>
            </div>
            <form action="{{ url_for('admin.admin_add_reward') }}" method="POST" style="padding: 25px;">
                <div class="form-group">
                    <label class="form-label">Reward Name</label>
                    <input type="text" name="name" class="form-input" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Description</label>
                    <textarea name="description" class="form-input" rows="3"></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">Points Required</label>
                    <input type="number" name="points_required" class="form-input" required min="1">
                </div>
                <div class="form-group">
                    <label class="form-label">Total Quantity (leave empty for unlimited)</label>
                    <input type="number" name="total_quantity" class="form-input" min="1">
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn-cancel" onclick="closeAddRewardModal()">Cancel</button>
                    <button type="submit" class="btn-submit">Add Reward</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Edit Reward Modal -->
    <div id="editRewardModal" class="modal-overlay">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h2>Edit Reward</h2>
                <button class="modal-close" onclick="closeEditRewardModal()">&times;</button>
            </div>
            <form id="editRewardForm" action="" method="POST" style="padding: 25px;">
                <div class="form-group">
                    <label class="form-label">Reward Name</label>
                    <input type="text" name="name" id="editRewardName" class="form-input" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Description</label>
                    <textarea name="description" id="editRewardDescription" class="form-input" rows="3"></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">Points Required</label>
                    <input type="number" name="points_required" id="editRewardPoints" class="form-input" required
                        min="1">
                </div>
                <div class="form-group">
                    <label class="form-label">Total Quantity</label>
                    <input type="number" name="total_quantity" id="editRewardQuantity" class="form-input" min="1"
                        placeholder="Unlimited">
                </div>
                <div class="form-group" style="display: flex; align-items: center; gap: 10px;">
                    <input type="checkbox" name="is_active" id="editRewardActive" style="width: auto;">
                    <label for="editRewardActive" class="form-label" style="margin: 0; cursor: pointer;">Active
                        Status</label>
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn-cancel" onclick="closeEditRewardModal()">Cancel</button>
                    <button type="submit" class="btn-submit">Save Changes</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Delete Reward Modal -->
    <div id="deleteRewardModal" class="modal-overlay">
        <div class="modal-content"
            style="max-width: 480px; background: linear-gradient(135deg, #374151 0%, #1f2937 100%); border: 1px solid rgba(239, 68, 68, 0.3); box-shadow: 0 25px 50px rgba(0, 0, 0, 0.6);">
            <div class="modal-header" style="border-bottom: 1px solid rgba(239, 68, 68, 0.2); padding: 25px;">
                <h2 style="color: #f87171; display: flex; align-items: center; gap: 10px; margin: 0; font-size: 1.4em;">
                    <i class="bi bi-exclamation-triangle" style="animation: pulse 2s ease-in-out infinite;"></i>
                    Delete Reward
                </h2>
                <button class="modal-close" onclick="closeDeleteRewardModal()"
                    style="transition: all 0.3s ease;">&times;</button>
            </div>
            <div style="padding: 25px;">
                <div
                    style="background: linear-gradient(135deg, rgba(239, 68, 68, 0.2) 0%, rgba(239, 68, 68, 0.1) 100%); border: 2px solid rgba(239, 68, 68, 0.4); border-radius: 12px; padding: 24px; text-align: center; margin-bottom: 24px; position: relative; overflow: hidden;">
                    <div
                        style="position: absolute; top: 0; left: 0; right: 0; height: 3px; background: linear-gradient(90deg, transparent, #f87171, transparent); animation: shimmer 2s infinite;">
                    </div>
                    <p style="color: #f3f4f6; margin: 0 0 8px; font-size: 1.1em; font-weight: 500;">
                        Delete reward <strong id="deleteRewardName" style="color: #fca5a5; font-weight: 700;"></strong>?
                    </p>
                    <p style="color: #9ca3af; margin: 0; font-size: 0.95em; line-height: 1.5;">
                        <i class="bi bi-shield-exclamation" style="color: #f87171; margin-right: 5px;"></i>
                        This action cannot be undone.
                    </p>
                </div>
                <form id="deleteRewardForm" action="" method="POST" style="display: inline;">
                    <div style="display: flex; gap: 12px; justify-content: flex-end;">
                        <button type="button" class="btn-cancel" onclick="closeDeleteRewardModal()"
                            style="padding: 12px 20px !important; font-weight: 600; transition: all 0.2s ease; width: 120px !important; flex-shrink: 0; box-sizing: border-box !important;">Cancel</button>
                        <button type="submit" class="btn-submit"
                            style="padding: 12px 20px !important; font-weight: 700; background: linear-gradient(135deg, #ef4444, #dc2626) !important; transition: all 0.2s ease; box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3); width: 120px !important; flex-shrink: 0; box-sizing: border-box !important;">Delete</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <style>
        @keyframes pulse {

            0%,
            100% {
                opacity: 1;
                transform: scale(1);
            }

            50% {
                opacity: 0.7;
                transform: scale(1.1);
            }
        }

        @keyframes shimmer {
            0% {
                transform: translateX(-100%);
            }

            100% {
                transform: translateX(100%);
            }
        }

        #deleteRewardModal .btn-submit:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(239, 68, 68, 0.5);
            background: linear-gradient(135deg, #fca5a5, #ef4444);
        }

        #deleteRewardModal .btn-cancel:hover {
            transform: translateY(-1px);
            background: #6b7280;
        }

        #deleteRewardModal .modal-close:hover {
            transform: rotate(90deg);
            color: #f87171;
        }
    </style>

    <script>
        // Section Tab Switching
        const sectionTabs = document.querySelectorAll('#sectionTabs .filter-tab');
        const sections = document.querySelectorAll('.section-content');

        sectionTabs.forEach(tab => {
            tab.addEventListener('click', () => {
                const targetSection = tab.dataset.section;

                sectionTabs.forEach(t => t.classList.remove('active'));
                tab.classList.add('active');

                sections.forEach(section => {
                    section.classList.remove('active');
                    if (section.id === `${targetSection}-section`) {
                        section.classList.add('active');
                    }
                });
            });
        });

        // Rewards Sub-tab Switching
        const rewardsTabs = document.querySelectorAll('#rewardsTabs .filter-tab');
        const rewardsTabContents = document.querySelectorAll('#rewards-section .tab-content');

        rewardsTabs.forEach(tab => {
            tab.addEventListener('click', () => {
                const targetTab = tab.dataset.tab;

                rewardsTabs.forEach(t => t.classList.remove('active'));
                tab.classList.add('active');

                rewardsTabContents.forEach(content => {
                    content.classList.remove('active');
                    if (content.id === `${targetTab}-tab`) {
                        content.classList.add('active');
                    }
                });
            });
        });

        // Add Reward Modal
        function openAddRewardModal() {
            document.getElementById('addRewardModal').classList.add('active');
        }

        function closeAddRewardModal() {
            document.getElementById('addRewardModal').classList.remove('active');
        }

        // Edit Reward Modal - Using Event Delegation
        document.addEventListener('click', function (e) {
            if (e.target.closest('.edit-reward-btn')) {
                const btn = e.target.closest('.edit-reward-btn');
                const rewardId = btn.dataset.rewardId;
                const name = btn.dataset.name;
                const description = btn.dataset.description;
                const points = btn.dataset.points;
                const quantity = btn.dataset.quantity;
                const active = btn.dataset.active === '1' || btn.dataset.active === 'True';

                document.getElementById('editRewardName').value = name;
                document.getElementById('editRewardDescription').value = description;
                document.getElementById('editRewardPoints').value = points;
                document.getElementById('editRewardQuantity').value = quantity;
                document.getElementById('editRewardActive').checked = active;

                document.getElementById('editRewardForm').action = `/admin/edit-reward/${rewardId}`;
                document.getElementById('editRewardModal').classList.add('active');
            }
        });

        function closeEditRewardModal() {
            document.getElementById('editRewardModal').classList.remove('active');
        }

        // Delete Reward Modal - Using Event Delegation
        document.addEventListener('click', function (e) {
            if (e.target.closest('.delete-reward-btn')) {
                const btn = e.target.closest('.delete-reward-btn');
                const rewardId = btn.dataset.rewardId;
                const rewardName = btn.dataset.rewardName;

                document.getElementById('deleteRewardName').textContent = rewardName;
                document.getElementById('deleteRewardForm').action = `/admin/delete-reward/${rewardId}`;
                document.getElementById('deleteRewardModal').classList.add('active');
            }
        });

        function closeDeleteRewardModal() {
            document.getElementById('deleteRewardModal').classList.remove('active');
        }

        // Close Modals on Overlay Click
        document.querySelectorAll('.modal-overlay').forEach(overlay => {
            overlay.addEventListener('click', (e) => {
                if (e.target === overlay) {
                    overlay.classList.remove('active');
                }
            });
        });

        // Status Filter for Redeemed Rewards Tab
        document.querySelectorAll('.status-filter-btn').forEach(btn => {
            btn.addEventListener('click', function () {
                const filterStatus = this.dataset.status;

                // Update active button style
                document.querySelectorAll('.status-filter-btn').forEach(b => {
                    b.classList.remove('active');
                    b.style.background = '#4b5563';
                });
                this.classList.add('active');
                this.style.background = '#3b82f6';

                // Filter table rows
                document.querySelectorAll('.redeemed-row').forEach(row => {
                    if (filterStatus === 'all' || row.dataset.status === filterStatus) {
                        row.style.display = '';
                    } else {
                        row.style.display = 'none';
                    }
                });
            });
        });

        // CSS for sections and tabs
        const style = document.createElement('style');
        style.textContent = `
            .section-content {
                display: none;
            }
            .section-content.active {
                display: block;
            }
            .tab-content {
                display: none;
            }
            .tab-content.active {
                display: block;
            }
        `;
        document.head.appendChild(style);
    </script>
</body>

</html>